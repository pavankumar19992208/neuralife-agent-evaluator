name: Deploy to EC2

on:
    push:
        branches: [master]
    workflow_dispatch:

concurrency:
    group: deploy-main
    cancel-in-progress: false

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup SSH agent
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

            - name: Deploy to EC2
              env:
                  HOST: ${{ secrets.EC2_HOST }} # e.g. 65.1.xx.xx
                  USER: ${{ secrets.EC2_USER }} # e.g. ubuntu
              run: |
                  ssh -o StrictHostKeyChecking=no $USER@$HOST 'bash -s' << 'EOF'
                  set -euo pipefail
                  APP_DIR=/home/ubuntu/neuralife-agent-evaluator

                  # Clone if first time
                  if [ ! -d "$APP_DIR/.git" ]; then
                    git clone https://github.com/pavankumar19992208/neuralife-agent-evaluator.git "$APP_DIR"
                  fi

                  cd "$APP_DIR"
                  # Ensure git uses the public URL (no credentials needed)
                  git remote set-url origin https://github.com/pavankumar19992208/neuralife-agent-evaluator.git
                  # Sync to latest main
                  git fetch --all
                  if git show-ref --verify --quiet refs/remotes/origin/main; then
                    git reset --hard origin/main
                  else
                    git reset --hard origin/master
                  fi

                  # Build and (re)start
                  docker compose pull || true
                  docker compose build --no-cache
                  docker compose up -d --remove-orphans

                  # Cleanup old images
                  docker image prune -f || true

                  # Health check
                  curl -s http://localhost:8000/health || true
                  EOF

            - name: Remote health check
              env:
                  HOST: ${{ secrets.EC2_HOST }}
                  USER: ${{ secrets.EC2_USER }}
              run: |
                  ssh -o StrictHostKeyChecking=no $USER@$HOST "curl -s http://localhost:8000/health || echo 'Health check failed'"
