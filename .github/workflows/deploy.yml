name: Deploy to EC2
on:
    push:
        branches: [master]
    workflow_dispatch:

concurrency:
    group: deploy-main
    cancel-in-progress: false
jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup SSH agent
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

            - name: Deploy
              env:
                  HOST: ${{ secrets.EC2_HOST }}
                  USER: ${{ secrets.EC2_USER }}
                  APP_DIR: /home/ubuntu/neuralife-agent-evaluator
              run: |
                  ssh -o StrictHostKeyChecking=no $USER@$HOST "\
                    if [ ! -d $APP_DIR ]; then git clone https://github.com/<your-org>/neuralife-agent-evaluator.git $APP_DIR; fi; \
                    cd $APP_DIR; \
                    git fetch --all; \
                    git reset --hard origin/main; \
                    docker compose pull || true; \
                    docker compose build --no-cache; \
                    docker compose up -d --remove-orphans; \
                    docker image prune -f; \
                    curl -s http://localhost:8000/health || true \
                  "

            - name: Health check
              env:
                  HOST: ${{ secrets.EC2_HOST }}
                  USER: ${{ secrets.EC2_USER }}
              run: |
                  ssh -o StrictHostKeyChecking=no $USER@$HOST "curl -s http://localhost:8000/health || echo 'Health check failed'"
